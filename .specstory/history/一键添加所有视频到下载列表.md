## SpecStory

## 一键添加所有视频到下载列表 (2025/2/3 15:31:37)

_**User**_

加上一键添加所有视频最高画质到下载列表的按钮

---

_**Assistant**_

我将帮你在GUI中添加一个一键添加所有视频最高画质到下载列表的按钮。以下是修改建议：

```python:Bilibili_fav_downloader.py
# 在create_widgets方法中的button_frame部分添加新按钮
# 在现有按钮之后添加

# ... 现有的button_frame代码 ...

# 添加一键添加所有视频按钮
self.add_all_btn = ttk.Button(
    button_frame, 
    text="一键添加全部", 
    command=self.add_all_to_queue,
    state='disabled'
)
self.add_all_btn.grid(row=0, column=6, padx=2)  # 添加到最后一列

# 更新列权重配置
for i in range(7):  # 现在有7个按钮
    button_frame.columnconfigure(i, weight=1)

# ... 其他代码 ...

# 在list_favorites_thread方法中启用一键添加按钮
# 在启用add_to_queue_btn之后添加
self.add_to_queue_btn.state(['!disabled'])
self.add_all_btn.state(['!disabled'])  # 启用一键添加按钮

# 添加新方法
def add_all_to_queue(self):
    """一键添加所有视频到下载队列（使用最高画质）"""
    try:
        # 获取输出目录
        output_dir = self.output_dir_var.get()
        if not output_dir:
            messagebox.showwarning("提示", "请先选择输出目录")
            return
            
        # 确认对话框
        if not messagebox.askyesno("确认", "是否将所有视频以最高画质添加到下载队列？"):
            return
            
        added_count = 0
        skipped_count = 0
        
        # 遍历所有视频
        for item_id in self.download_list.get_children():
            item = self.download_list.item(item_id)
            status = item['values'][2]
            formats_str = item['values'][3]
            video_id = item['values'][6]
            title = item['values'][1]
            
            # 跳过已在队列或已完成的视频
            if status in ["已在队列", "下载中", "已完成"]:
                skipped_count += 1
                continue
            
            # 跳过未获取格式的视频
            if status == "等待获取格式...":
                self.logger.warning(f"跳过未获取格式的视频：{title}")
                skipped_count += 1
                continue
            
            formats = formats_str.split('\n')
            if not formats or formats[0] == "获取格式失败":
                self.logger.warning(f"跳过格式获取失败的视频：{title}")
                skipped_count += 1
                continue
            
            try:
                # 选择第一个格式（最高画质）
                first_format = formats[0]
                format_match = re.search(r'\((.*?)\)', first_format)
                if not format_match:
                    self.logger.error(f"无法从 {first_format} 提取格式代码")
                    skipped_count += 1
                    continue
                    
                format_code = format_match.group(1)
                self.logger.info(f"为视频 {title} 选择格式：{first_format} (代码: {format_code})")
                
                # 添加到下载队列
                self.download_queue.put((video_id, title, format_code, output_dir, item_id))
                self.download_list.set(item_id, '状态', "已在队列")
                added_count += 1
                
            except Exception as e:
                self.logger.error(f"处理视频 {title} 时出错：{str(e)}")
                skipped_count += 1
                continue
        
        # 显示结果
        message = f"成功添加 {added_count} 个视频到下载队列"
        if skipped_count > 0:
            message += f"\n跳过 {skipped_count} 个视频"
        messagebox.showinfo("添加完成", message)
        
        if added_count > 0:
            # 启用开始下载按钮
            self.start_queue_btn.state(['!disabled'])
            
    except Exception as e:
        self.logger.error(f"一键添加视频时出错：{str(e)}")
        messagebox.showerror("错误", f"一键添加视频时出错：{str(e)}")
```

这些修改添加了以下功能：

1. 在按钮栏添加了"一键添加全部"按钮
2. 当获取视频列表完成后，按钮会被启用
3. 点击按钮后会：
   - 检查输出目录是否已选择
   - 显示确认对话框
   - 遍历所有视频，自动选择最高画质格式
   - 跳过已在队列、已完成或格式获取失败的视频
   - 将视频添加到下载队列
   - 显示添加结果的统计信息
4. 添加完成后会自动启用"开始下载队列"按钮

这个功能可以让用户快速将所有视频以最高画质添加到下载队列，而不需要手动选择每个视频的格式。同时也会跳过已经在队列中或已完成的视频，避免重复添加。

---



---

